# Dump build stage
FROM postgres:latest as dumper

# Copy the initialization script to the Docker entrypoint directory
COPY test.sql /docker-entrypoint-initdb.d/

# This line uses sed to modify the docker-entrypoint.sh script. 
# It replaces the line that executes the main command (exec "$@") with a line that echoes "skipping...". 
# This effectively disables the default entrypoint behavior.
RUN ["sed", "-i", "s/exec \"$@\"/echo \"skipping...\"/", "/usr/local/bin/docker-entrypoint.sh"]

# Set environment variables for the PostgreSQL database
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=gatineosFofineos
ENV POSTGRES_DB=eLibrosDB
ENV POSTGRES_DATA=/var/lib/postgresql/data

# Run the entrypoint script to initialize the database
RUN ["/usr/local/bin/docker-entrypoint.sh", "postgres"]

# Final build stage
FROM postgres:latest

COPY --from=dumper /var/lib/postgresql/data $POSTGRES_DATA